<!DOCTYPE html>
<html lang="id">

<head>
    <script>
        const token = localStorage.getItem('sna_user_token');
        const userData = JSON.parse(localStorage.getItem('sna_user_data'));
        if (!token || !userData || userData.role !== 'judge') window.location.href = 'login.html';
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnaDaily | Scoring Panel</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/seasonal-themes.css">
    <script src="js/seasonal-manager.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body {
            background: var(--bg-dark);
            min-height: 100vh;
        }

        .scoring-card {
            background: var(--glass-premium);
            backdrop-filter: blur(40px);
            border: 1px solid var(--glass-premium-border);
            border-radius: 30px;
            padding: 2.5rem;
            box-shadow: var(--shadow-diffuse);
            transition: var(--transition);
        }

        .criteria-row {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            border: 1px solid var(--glass-premium-border);
            transition: var(--transition);
        }

        .criteria-row:hover {
            background: var(--glass-premium-bright);
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            outline: none;
            margin: 20px 0;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 15px var(--primary-glow);
            transition: var(--transition);
            border: 3px solid white;
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px var(--primary-glow);
        }

        .entry-card-mini {
            background: var(--glass-premium);
            border: 1px solid var(--glass-premium-border);
            border-radius: 20px;
            padding: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .entry-card-mini:hover {
            background: var(--glass-premium-bright);
            border-color: var(--primary);
            transform: translateX(10px) translateY(-2px);
            box-shadow: var(--shadow-float);
        }

        .entry-card-mini.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
        }

        .total-score-display {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 4rem;
            font-weight: 900;
            line-height: 1;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.3));
        }

        .compare-item {
            border-radius: 24px;
            overflow: hidden;
            background: var(--glass-premium);
            border: 1px solid var(--glass-premium-border);
            transition: var(--transition);
        }

        .compare-item:hover {
            border-color: var(--primary);
            transform: translateY(-10px);
            box-shadow: var(--shadow-float);
        }

        .judge-scoring-main {
            display: grid;
            grid-template-columns: 1fr 480px;
            gap: 2.5rem;
            margin-top: 2rem;
            padding-bottom: 5rem;
        }

        @media (max-width: 1024px) {
            .judge-scoring-main {
                grid-template-columns: 1fr !important;
                gap: 1.5rem !important;
                margin-top: 0.5rem !important;
            }

            .glass-panel {
                padding: 1.5rem !important;
            }

            .contestant-header {
                margin-bottom: 1.5rem !important;
            }
        }

        @media (max-width: 480px) {
            .total-score-display {
                font-size: 2.2rem;
            }

            .scoring-card {
                padding: 1.2rem;
                border-radius: 20px;
            }

            .criteria-row {
                padding: 0.8rem 1rem;
                margin-bottom: 0.75rem;
            }

            .entry-card-mini {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .entry-card-mini img {
                width: 50px;
                height: 50px;
            }

            .no-select-msg {
                padding: 3rem 1.5rem !important;
            }
        }

        .mobile-back-btn {
            display: none;
            margin-bottom: 1rem;
            color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--primary-glow);
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.8rem;
            width: 100%;
            text-align: center;
        }

        @media (max-width: 1024px) {
            .mobile-back-btn {
                display: block;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar glass">
        <div class="container nav-container">
            <a href="judge.html" class="nav-link-premium" style="background: transparent; color: var(--text-muted);">
                <i class="ri-arrow-left-line"></i> Dashboard
            </a>
            <div style="flex: 1; text-align: right; min-width: 0;">
                <span id="eventNameHeader"
                    style="font-weight: 800; font-size: clamp(0.75rem, 3.5vw, 1rem); color: white; letter-spacing: 0px; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;">Event
                    Title</span>
            </div>
            <!-- Removed fixed spacer -->
        </div>
    </nav>

    <main class="container judge-scoring-main">
        <!-- Left: Contestant List -->
        <section class="animate-fade-in">
            <div class="glass-panel" style="padding: 2.5rem; height: 100%;">
                <div class="contestant-header"
                    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2.5rem; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="width: 4px; height: 28px; background: var(--secondary); border-radius: 10px; box-shadow: 0 0 15px var(--secondary);">
                        </div>
                        <h2
                            style="font-size: clamp(1.2rem, 4vw, 1.6rem); font-weight: 900; letter-spacing: -0.5px; margin: 0;">
                            Daftar <span class="text-gradient">Kontestan</span></h2>
                    </div>
                    <button class="tab-btn" id="compareToggle" onclick="toggleCompareMode()"
                        style="font-size: 0.85rem; padding: 8px 20px; border-radius: 12px; white-space: nowrap;">
                        <i class="ri-layout-grid-line"></i> <span class="mobile-hide">Mode</span> Bandingkan
                    </button>
                </div>

                <style>
                    @media (max-width: 540px) {
                        .contestant-header {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 1rem !important;
                        }

                        #compareToggle {
                            width: 100%;
                        }
                    }
                </style>

                <div id="entriesList" style="display: grid; gap: 1rem;">
                    <!-- Entries injected here -->
                </div>

                <!-- Comparison Grid (Hidden by default) -->
                <div id="compareGrid"
                    style="display: none; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- Grid contents injected here -->
                </div>
            </div>
        </section>

        <!-- Right: Scoring Panel (Sticky) -->
        <aside id="scoringSidePanel">
            <button class="mobile-back-btn" onclick="cancelScoring()">
                <i class="ri-arrow-left-s-line"></i> Kembali ke Daftar Kontestan
            </button>
            <div id="scoringSection" class="scoring-card animate-fade-in"
                style="position: sticky; top: 6rem; display: none;">
                <div id="selectedFishInfo" style="margin-bottom: 2.5rem;">
                    <div
                        style="position: relative; margin-bottom: 1.5rem; border-radius: 20px; overflow: hidden; background: #000; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <img id="fishPreview" src=""
                            style="width: 100%; aspect-ratio: 16/9; height: auto; object-fit: contain; display: block;">
                        <video id="fishVideo" controls
                            style="width: 100%; aspect-ratio: 16/9; height: auto; display: none; object-fit: contain; background: #000;"></video>

                        <div id="mediaToggleContainer"
                            style="position: absolute; bottom: 1.5rem; right: 1.5rem; display: none; z-index: 10;">
                            <button id="mediaToggleBtn" onclick="toggleMedia()" class="btn-primary"
                                style="font-size: 0.8rem; padding: 12px 24px; border-radius: 14px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow-float); border: 1px solid rgba(255,255,255,0.3); font-weight: 800; letter-spacing: 1px;">
                                <i class="ri-play-mini-fill" style="font-size: 1.4rem;"></i> LIHAT VIDEO
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div style="flex: 1;">
                            <h3 id="fishTitle"
                                style="font-weight: 900; font-size: 1.6rem; margin-bottom: 0rem; letter-spacing: -0.5px; line-height: 1.2;">
                                Nama Ikan</h3>
                            <p id="fishType"
                                style="color: var(--primary); font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                                Jenis Ikan</p>
                        </div>
                        <div style="text-align: right; min-width: 80px;">
                            <div
                                style="font-size: 0.65rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; line-height: 1;">
                                Score</div>
                            <div id="totalScoreVal" class="total-score-display">0</div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 5px;"
                        class="hide-scrollbar">
                        <div class="glass-panel"
                            style="padding: 0.8rem 1.2rem; min-width: 120px; font-size: 0.8rem; flex-shrink: 0;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">TIM</div>
                            <div id="teamVal" style="font-weight: 700;">-</div>
                        </div>
                        <div class="glass-panel"
                            style="padding: 0.8rem 1.2rem; min-width: 120px; font-size: 0.8rem; flex-shrink: 0;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">WA</div>
                            <div id="waVal" style="font-weight: 700;">-</div>
                        </div>
                    </div>
                </div>

                <form id="scoringForm">
                    <input type="hidden" id="selectedEntryId">

                    <div class="criteria-row">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label style="font-weight: 800; font-size: 0.85rem; color: #fff;">BODY <span
                                    style="font-weight: 400; color: var(--text-muted); font-size: 0.75rem;">(Badan &
                                    Proporsi)</span></label>
                            <span id="bodyVal"
                                style="color: var(--primary); font-weight: 900; font-size: 1.2rem;">0</span>
                        </div>
                        <input type="range" id="input_body" class="range-slider" min="0" max="100" value="0"
                            oninput="updateScoreUI()">
                    </div>

                    <div class="criteria-row">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label style="font-weight: 800; font-size: 0.85rem; color: #fff;">FORM <span
                                    style="font-weight: 400; color: var(--text-muted); font-size: 0.75rem;">(Bentuk &
                                    Finage)</span></label>
                            <span id="formVal"
                                style="color: var(--primary); font-weight: 900; font-size: 1.2rem;">0</span>
                        </div>
                        <input type="range" id="input_form" class="range-slider" min="0" max="100" value="0"
                            oninput="updateScoreUI()">
                    </div>

                    <div class="criteria-row">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label style="font-weight: 800; font-size: 0.85rem; color: #fff;">COLOR <span
                                    style="font-weight: 400; color: var(--text-muted); font-size: 0.75rem;">(Warna &
                                    Pola)</span></label>
                            <span id="colorVal"
                                style="color: var(--primary); font-weight: 900; font-size: 1.2rem;">0</span>
                        </div>
                        <input type="range" id="input_color" class="range-slider" min="0" max="100" value="0"
                            oninput="updateScoreUI()">
                    </div>

                    <div class="input-group">
                        <label class="input-label" style="font-size: 0.8rem; font-weight: 700;">Catatan Juri</label>
                        <textarea id="judgeComment" class="glass-input"
                            style="height: 80px; resize: none; border-radius: 15px;"
                            placeholder="Tulis alasan atau saran..."></textarea>
                    </div>

                    <button type="submit" class="btn-primary"
                        style="width: 100%; margin-top: 1rem; height: 50px; border-radius: 15px; font-weight: 900; font-size: 0.95rem; letter-spacing: 1px;">
                        SIMPAN SKOR <i class="ri-send-plane-fill" style="margin-left: 8px;"></i>
                    </button>

                    <button type="button" onclick="cancelScoring()" class="tab-btn"
                        style="width: 100%; margin-top: 0.8rem; border: none; font-size: 0.8rem;">BATALKAN</button>
                </form>
            </div>

            <div id="noSelectMsg" class="scoring-card animate-fade-in no-select-msg"
                style="padding: 5rem 2rem; text-align: center; border-style: dashed;">
                <div
                    style="width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%; display: grid; place-items: center; margin: 0 auto 2rem;">
                    <i class="ri-cursor-line" style="font-size: 2.5rem; color: var(--text-muted);"></i>
                </div>
                <h3 style="font-size: 1.2rem; font-weight: 800; margin-bottom: 0.5rem;">Cak, Pilih Ikan Dulu</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Klik salah satu ikan dari daftar di samping
                    untuk memulai penilaian.</p>
            </div>
        </aside>
    </main>

    <script src="js/navigation.js"></script>
    <script>
        let currentEventId = new URLSearchParams(window.location.search).get('eventId');
        let allEntries = [];

        const escapeHTML = (str) => {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (!currentEventId) window.location.href = 'judge.html';
            fetchEventInfo();
            fetchEntries();
        });

        async function fetchEventInfo() {
            // Simple logic to get event title from list
            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch('/api/judge/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success) {
                    const event = data.data.find(e => e.id == currentEventId);
                    if (event) document.getElementById('eventNameHeader').innerText = event.title;
                }
            } catch (err) { }
        }

        async function fetchEntries() {
            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch(`/api/judge/events/${currentEventId}/entries`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    allEntries = data.data;
                    renderEntries();
                }
            } catch (err) {
                console.error(err);
            }
        }

        function renderEntries() {
            const list = allEntries;
            const entriesList = document.getElementById('entriesList');
            const compareGrid = document.getElementById('compareGrid');

            if (list.length === 0) {
                entriesList.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 5rem;">Belum ada kontestan yang disetujui di event ini.</p>`;
                return;
            }

            // List View
            entriesList.innerHTML = list.map((entry, index) => `
                <div class="entry-card-mini animate-reveal ${entry.id == document.getElementById('selectedEntryId').value ? 'active' : ''}" 
                    onclick="selectEntry(${JSON.stringify(entry).replace(/"/g, '&quot;')})"
                    style="animation-delay: ${index * 0.05}s; ${entry.score ? 'border-left: 4px solid var(--secondary);' : ''}">
                    <div style="width: 70px; height: 70px; border-radius: 14px; overflow: hidden; border: 1px solid var(--glass-premium-border); flex-shrink: 0;">
                        <img src="${escapeHTML(entry.fish_image_url)}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 900; font-size: 1.1rem; color: white; letter-spacing: -0.5px;">${escapeHTML(entry.fish_name)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; margin-top: 4px;">
                            ${escapeHTML(entry.team_name || entry.contestant_name)} â€¢ <span style="color: var(--primary)">${escapeHTML(entry.fish_type)}</span>
                        </div>
                    </div>
                    ${entry.score ? `
                        <div style="text-align: right; background: rgba(0,255,136,0.1); padding: 8px 15px; border-radius: 12px; border: 1px solid rgba(0,255,136,0.2);">
                            <div style="font-size: 0.6rem; color: var(--secondary); font-weight: 900; letter-spacing: 1px;">TOTAL</div>
                            <div style="color: var(--secondary); font-weight: 900; font-size: 1.4rem; line-height: 1;">${entry.score}</div>
                        </div>
                    ` : `
                        <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.05); border-radius: 10px; display: grid; place-items: center; color: var(--text-muted);">
                            <i class="ri-edit-2-line"></i>
                        </div>
                    `}
                </div>
            `).join('');

            // Grid View
            compareGrid.innerHTML = list.map((entry, index) => `
                <div class="compare-item animate-reveal" onclick="selectEntry(${JSON.stringify(entry).replace(/"/g, '&quot;')})" 
                    style="cursor: pointer; position: relative; animation-delay: ${index * 0.05}s; ${entry.id == document.getElementById('selectedEntryId').value ? 'border: 2px solid var(--primary); transform: translateY(-5px);' : ''}">
                    <div style="aspect-ratio: 4/3; overflow: hidden; position: relative;">
                        <img src="${escapeHTML(entry.fish_image_url)}" style="width: 100%; height: 100%; object-fit: cover;">
                        ${entry.score ? `
                            <div style="position: absolute; top: 10px; right: 10px; background: var(--secondary); color: #000; font-weight: 900; padding: 4px 10px; border-radius: 8px; font-size: 0.9rem; box-shadow: 0 5px 15px rgba(0,255,136,0.4);">
                                ${entry.score}
                            </div>
                        ` : ''}
                    </div>
                    <div style="padding: 1.25rem;">
                        <div style="font-weight: 900; font-size: 1rem; color: white; letter-spacing: -0.5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${escapeHTML(entry.fish_name)}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; margin-top: 4px;">${escapeHTML(entry.fish_type)}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCompareMode() {
            const list = document.getElementById('entriesList');
            const grid = document.getElementById('compareGrid');
            const btn = document.getElementById('compareToggle');

            if (list.style.display === 'none') {
                list.style.display = 'grid';
                grid.style.display = 'none';
                btn.innerHTML = '<i class="ri-layout-grid-line"></i> Mode Bandingkan';
                btn.classList.remove('active');
            } else {
                list.style.display = 'none';
                grid.style.display = 'grid';
                btn.innerHTML = '<i class="ri-list-check"></i> Mode List';
                btn.classList.add('active');
            }
        }

        function selectEntry(entry) {
            document.getElementById('noSelectMsg').style.display = 'none';
            document.getElementById('scoringSection').style.display = 'block';

            document.getElementById('selectedEntryId').value = entry.id;
            document.getElementById('fishTitle').innerText = entry.fish_name;
            document.getElementById('fishType').innerText = entry.fish_type;
            document.getElementById('fishPreview').src = entry.fish_image_url;
            document.getElementById('teamVal').innerText = entry.team_name || '-';
            document.getElementById('waVal').innerText = entry.wa_number || '-';

            // Video Reset
            const fishPreview = document.getElementById('fishPreview');
            const fishVideo = document.getElementById('fishVideo');
            const toggleContainer = document.getElementById('mediaToggleContainer');
            const toggleBtn = document.getElementById('mediaToggleBtn');

            // Always start with photo
            fishPreview.style.display = 'block';
            fishVideo.style.display = 'none';
            fishVideo.pause();
            fishVideo.src = '';
            toggleBtn.innerHTML = '<i class="ri-play-circle-fill" style="font-size: 1.2rem;"></i> LIAT VIDEO';

            if (entry.video_url) {
                toggleContainer.style.display = 'block';
                fishVideo.src = entry.video_url;
            } else {
                toggleContainer.style.display = 'none';
            }

            // Set scores from entry (if any)
            document.getElementById('input_body').value = entry.score_body || 0;
            document.getElementById('input_form').value = entry.score_form || 0;
            document.getElementById('input_color').value = entry.score_color || 0;
            document.getElementById('judgeComment').value = entry.judge_comment || '';

            updateScoreUI();
            renderEntries();

            if (window.innerWidth < 1024) {
                document.getElementById('scoringSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updateScoreUI() {
            const body = parseInt(document.getElementById('input_body').value);
            const form = parseInt(document.getElementById('input_form').value);
            const color = parseInt(document.getElementById('input_color').value);

            document.getElementById('bodyVal').innerText = body;
            document.getElementById('formVal').innerText = form;
            document.getElementById('colorVal').innerText = color;

            const total = Math.round((body + form + color) / 3);
            document.getElementById('totalScoreVal').innerText = total;
        }

        function toggleMedia() {
            const preview = document.getElementById('fishPreview');
            const video = document.getElementById('fishVideo');
            const btn = document.getElementById('mediaToggleBtn');

            if (video.style.display === 'none') {
                preview.style.display = 'none';
                video.style.display = 'block';
                video.play();
                btn.innerHTML = '<i class="ri-image-fill" style="font-size: 1.2rem;"></i> LIAT FOTO';
            } else {
                preview.style.display = 'block';
                video.style.display = 'none';
                video.pause();
                btn.innerHTML = '<i class="ri-play-circle-fill" style="font-size: 1.2rem;"></i> LIAT VIDEO';
            }
        }

        function cancelScoring() {
            document.getElementById('selectedEntryId').value = '';
            document.getElementById('scoringSection').style.display = 'none';
            document.getElementById('noSelectMsg').style.display = 'block';
            renderEntries();
        }

        document.getElementById('scoringForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('selectedEntryId').value;
            const payload = {
                score_body: parseInt(document.getElementById('input_body').value),
                score_form: parseInt(document.getElementById('input_form').value),
                score_color: parseInt(document.getElementById('input_color').value),
                comment: document.getElementById('judgeComment').value
            };

            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch(`/api/judge/entries/${id}/score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    alert('Penilaian berhasil disimpan!');
                    fetchEntries();
                    cancelScoring();
                }
            } catch (err) {
                alert('Gagal menyimpan nilai');
            }
        });
    </script>
</body>

</html>