<!DOCTYPE html>
<html lang="id">

<head>
    <script>
        const token = localStorage.getItem('sna_user_token');
        const userData = JSON.parse(localStorage.getItem('sna_user_data'));
        if (!token || !userData || userData.role !== 'judge') window.location.href = 'login.html';
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnaDaily | Scoring Panel</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/seasonal-themes.css">
    <script src="js/theme-switcher.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body {
            background: radial-gradient(circle at 50% 0%, #0a192f 0%, #010409 100%);
            min-height: 100vh;
        }

        .glass-panel {
            padding: 2.5rem;
        }

        .scoring-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .criteria-row {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .criteria-row:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            outline: none;
            margin: 15px 0;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary);
            transition: all 0.2s;
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .entry-card-mini {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .entry-card-mini:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .entry-card-mini.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }

        .total-score-display {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1;
        }

        .compare-item {
            border-radius: 20px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .compare-item:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .judge-scoring-main {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 2rem;
            margin-top: 2rem;
            padding-bottom: 5rem;
        }

        @media (max-width: 1024px) {
            .judge-scoring-main {
                grid-template-columns: 1fr !important;
                gap: 1.5rem !important;
                margin-top: 0.5rem !important;
            }

            .glass-panel {
                padding: 1.5rem !important;
            }

            .contestant-header {
                margin-bottom: 1.5rem !important;
            }
        }

        @media (max-width: 480px) {
            .total-score-display {
                font-size: 2.2rem;
            }

            .scoring-card {
                padding: 1.2rem;
                border-radius: 20px;
            }

            .criteria-row {
                padding: 0.8rem 1rem;
                margin-bottom: 0.75rem;
            }

            .entry-card-mini {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .entry-card-mini img {
                width: 50px;
                height: 50px;
            }

            .no-select-msg {
                padding: 3rem 1.5rem !important;
            }
        }

        .mobile-back-btn {
            display: none;
            margin-bottom: 1rem;
            color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--primary-glow);
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.8rem;
            width: 100%;
            text-align: center;
        }

        @media (max-width: 1024px) {
            .mobile-back-btn {
                display: block;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <a href="judge.html" class="tab-btn"
                    style="width: 40px; height: 40px; border-radius: 12px; display: grid; place-items: center; background: rgba(255,255,255,0.05);">
                    <i class="ri-arrow-left-line"></i>
                </a>
                <div class="logo-icon mobile-hide">
                    <i class="ri-star-fill"></i>
                </div>
                <span id="eventNameHeader"
                    style="font-weight: 800; font-size: clamp(0.75rem, 3.5vw, 1rem); color: white; letter-spacing: 0px; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 200px;">Memuat...</span>
            </div>

            <div class="desktop-nav-links m-hide">
                <a href="index.html"
                    style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-decoration: none;">BERANDA
                    UTAMA</a>
            </div>

            <button class="hamburger-btn mobile-only"
                style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px;">
                <i class="ri-menu-4-line"></i>
            </button>
        </div>
    </nav>

    <div class="nav-overlay-backdrop" id="navBackdrop" onclick="toggleMenu()"></div>
    <div class="nav-overlay" id="navOverlay">
        <div class="nav-menu-header">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div
                    style="width: 32px; height: 32px; background: var(--secondary); border-radius: 8px; display: grid; place-items: center; color: #000;">
                    <i class="ri-star-fill"></i>
                </div>
                <span class="text-gradient" style="font-weight: 800; font-size: 1.25rem;">JUDGE MENU</span>
            </div>
            <button class="hamburger-btn" onclick="toggleMenu()">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="nav-menu-links">
            <a href="index.html" class="nav-menu-link">
                <i class="ri-home-4-line"></i> Beranda Utama
            </a>
            <a href="judge.html" class="nav-menu-link">
                <i class="ri-dashboard-3-line"></i> Judge Dashboard
            </a>
            <div id="userMenuLinks"></div>
        </div>
    </div>

    <main class="container judge-scoring-main">
        <!-- Left: Contestant List -->
        <section class="animate-fade-in">
            <div class="glass-panel" style="height: 100%;">
                <div class="contestant-header"
                    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2.5rem; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="width: 4px; height: 28px; background: var(--secondary); border-radius: 10px; box-shadow: 0 0 15px var(--secondary);">
                        </div>
                        <h2
                            style="font-size: clamp(1.2rem, 4vw, 1.6rem); font-weight: 900; letter-spacing: -0.5px; margin: 0;">
                            Daftar <span class="text-gradient">Kontestan</span></h2>
                    </div>
                    <div style="display: flex; gap: 0.8rem; align-items: center;">
                        <select id="classFilter" class="glass-input" onchange="renderEntries()"
                            style="padding: 8px 15px; border-radius: 12px; font-size: 0.85rem; width: auto; min-width: 140px; background: rgba(0,212,255,0.1); border-color: rgba(0,212,255,0.2); font-weight: 700; color: #fff;">
                            <option value="all">Semua Kelas</option>
                        </select>
                        <button class="tab-btn" id="compareToggle" onclick="toggleCompareMode()"
                            style="font-size: 0.85rem; padding: 8px 15px; border-radius: 12px; white-space: nowrap;">
                            <i class="ri-layout-grid-line"></i> <span class="mobile-hide">Mode</span> Bandingkan
                        </button>
                    </div>
                </div>

                <style>
                    @media (max-width: 640px) {
                        .contestant-header {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 1.2rem !important;
                        }

                        .contestant-header>div:last-child {
                            width: 100%;
                            flex-direction: column;
                        }

                        #classFilter,
                        #compareToggle {
                            width: 100% !important;
                        }
                    }
                </style>

                <div id="entriesContainer" style="display: grid; gap: 1rem;">
                    <!-- Divisions and Entries injected here -->
                </div>

                <!-- Comparison Grid (Hidden by default) -->
                <div id="compareGrid"
                    style="display: none; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- Grid contents injected here -->
                </div>
            </div>
        </section>

        <!-- Right: Scoring Panel (Sticky) -->
        <aside id="scoringSidePanel">
            <button class="mobile-back-btn" onclick="cancelScoring()">
                <i class="ri-arrow-left-s-line"></i> Kembali ke Daftar Kontestan
            </button>
            <div id="scoringSection" class="scoring-card animate-fade-in"
                style="position: sticky; top: 6rem; display: none;">
                <div id="selectedFishInfo" style="margin-bottom: 2.5rem;">
                    <div
                        style="position: relative; margin-bottom: 1.5rem; border-radius: 20px; overflow: hidden; background: #000; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <img id="fishPreview" src=""
                            style="width: 100%; aspect-ratio: 16/9; height: auto; object-fit: contain; display: block;">
                        <video id="fishVideo" controls
                            style="width: 100%; aspect-ratio: 16/9; height: auto; display: none; object-fit: contain; background: #000;"></video>

                        <div id="mediaToggleContainer"
                            style="position: absolute; bottom: 1rem; right: 1rem; display: none;">
                            <button id="mediaToggleBtn" onclick="toggleMedia()" class="btn-primary"
                                style="font-size: 0.75rem; padding: 10px 20px; border-radius: 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);">
                                <i class="ri-play-circle-fill" style="font-size: 1.2rem;"></i> LIAT VIDEO
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div style="flex: 1;">
                            <div id="entryNumberVal"
                                style="font-family: monospace; font-size: 0.85rem; font-weight: 900; color: var(--primary); margin-bottom: 0.4rem; padding: 4px 12px; background: rgba(0,212,255,0.1); border-radius: 10px; display: inline-block;">
                                -</div>
                            <h3 id="fishTitle"
                                style="font-weight: 900; font-size: 1.6rem; margin-bottom: 0rem; letter-spacing: -0.5px; line-height: 1.2;">
                                ${escapeHTML(entry.fish_name)}</h3>
                            <p id="fishType"
                                style="color: var(--primary); font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                                ${escapeHTML(entry.fish_type)}</p>
                        </div>
                        <div style="text-align: right; min-width: 80px;">
                            <div
                                style="font-size: 0.65rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; line-height: 1;">
                                Score</div>
                            <div id="totalScoreVal" class="total-score-display">0</div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 5px;"
                        class="hide-scrollbar">
                        <div class="glass-panel"
                            style="padding: 0.8rem 1.2rem; min-width: 120px; font-size: 0.8rem; flex-shrink: 0;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">TIM</div>
                            <div id="teamVal" style="font-weight: 700;">-</div>
                        </div>
                        <div class="glass-panel"
                            style="padding: 0.8rem 1.2rem; min-width: 120px; font-size: 0.8rem; flex-shrink: 0;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">WA</div>
                            <div id="waVal" style="font-weight: 700;">-</div>
                        </div>
                    </div>
                </div>

                <form id="scoringForm">
                    <input type="hidden" id="selectedEntryId">

                    <div class="criteria-row">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label style="font-weight: 800; font-size: 0.85rem; color: #fff;">BODY <span
                                    style="font-weight: 400; color: var(--text-muted); font-size: 0.75rem;">(Badan &
                                    Proporsi)</span></label>
                            <span id="bodyVal"
                                style="color: var(--primary); font-weight: 900; font-size: 1.2rem;">0</span>
                        </div>
                        <input type="range" id="input_body" class="range-slider" min="0" max="100" value="0"
                            oninput="updateScoreUI()">
                    </div>

                    <div class="criteria-row">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label style="font-weight: 800; font-size: 0.85rem; color: #fff;">FORM <span
                                    style="font-weight: 400; color: var(--text-muted); font-size: 0.75rem;">(Bentuk &
                                    Finage)</span></label>
                            <span id="formVal"
                                style="color: var(--primary); font-weight: 900; font-size: 1.2rem;">0</span>
                        </div>
                        <input type="range" id="input_form" class="range-slider" min="0" max="100" value="0"
                            oninput="updateScoreUI()">
                    </div>

                    <div class="criteria-row">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label style="font-weight: 800; font-size: 0.85rem; color: #fff;">COLOR <span
                                    style="font-weight: 400; color: var(--text-muted); font-size: 0.75rem;">(Warna &
                                    Pola)</span></label>
                            <span id="colorVal"
                                style="color: var(--primary); font-weight: 900; font-size: 1.2rem;">0</span>
                        </div>
                        <input type="range" id="input_color" class="range-slider" min="0" max="100" value="0"
                            oninput="updateScoreUI()">
                    </div>

                    <div class="input-group">
                        <label class="input-label" style="font-size: 0.8rem; font-weight: 700;">Catatan Juri</label>
                        <textarea id="judgeComment" class="glass-input"
                            style="height: 80px; resize: none; border-radius: 15px;"
                            placeholder="Tulis alasan atau saran..."></textarea>
                    </div>

                    <button type="submit" class="btn-primary"
                        style="width: 100%; margin-top: 1rem; height: 50px; border-radius: 15px; font-weight: 900; font-size: 0.95rem; letter-spacing: 1px;">
                        SIMPAN SKOR <i class="ri-send-plane-fill" style="margin-left: 8px;"></i>
                    </button>

                    <button type="button" onclick="cancelScoring()" class="tab-btn"
                        style="width: 100%; margin-top: 0.8rem; border: none; font-size: 0.8rem;">BATALKAN</button>
                </form>
            </div>

            <div id="noSelectMsg" class="scoring-card animate-fade-in no-select-msg"
                style="padding: 5rem 2rem; text-align: center; border-style: dashed;">
                <div
                    style="width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%; display: grid; place-items: center; margin: 0 auto 2rem;">
                    <i class="ri-cursor-line" style="font-size: 2.5rem; color: var(--text-muted);"></i>
                </div>
                <h3 style="font-size: 1.2rem; font-weight: 800; margin-bottom: 0.5rem;">Cak, Pilih Ikan Dulu</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Klik salah satu ikan dari daftar di samping
                    untuk memulai penilaian.</p>
            </div>
        </aside>
    </main>

    <script src="js/navigation.js"></script>
    <script>
        let currentEventId = new URLSearchParams(window.location.search).get('eventId');
        let allEntries = [];
        let judgingPhase = 'scoring';
        let eventEntriesForResults = [];
        let currentChampionshipStep = 1; // UI Step
        let phaseExpiry = null;
        let timerInterval = null;

        const escapeHTML = (str) => {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (!currentEventId) window.location.href = 'judge.html';
            fetchEventInfo();
            fetchEntries();
            fetchJudgingData();
        });

        async function fetchJudgingData() {
            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch(`/api/admin/judging/winners/${currentEventId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    eventEntriesForResults = data.data;
                    judgingPhase = data.phase || 'scoring';
                    phaseExpiry = data.expires_at ? new Date(data.expires_at) : null;

                    // Sync step to phase
                    if (judgingPhase === 'class') currentChampionshipStep = 1;
                    else if (judgingPhase === 'bod') currentChampionshipStep = 2;
                    else if (judgingPhase === 'gc') currentChampionshipStep = 3;

                    renderEntries();
                    startTimer();
                }
            } catch (err) { console.error(err); }
        }

        async function setChampionshipStep(step) {
            currentChampionshipStep = step;
            renderEntries();

            // UI Update for tabs
            document.querySelectorAll('.step-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.step) === step);
            });
        }

        async function setEventPhase(phase) {
            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch(`/api/admin/events/${currentEventId}/phase`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ phase })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`Fase diubah ke: ${phase.toUpperCase()}`);
                    fetchJudgingData();
                } else {
                    alert('Gagal ubah fase: ' + data.error);
                }
            } catch (err) { alert('Terjadi kesalahan: ' + err.message); }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            if (!phaseExpiry) {
                const timerEl = document.getElementById('phaseTimer');
                if (timerEl) timerEl.innerHTML = '';
                return;
            }

            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = phaseExpiry - now;
                const timerEl = document.getElementById('phaseTimer');
                if (!timerEl) return;

                if (diff <= 0) {
                    clearInterval(timerInterval);
                    timerEl.innerHTML = '<span style="color: #ff4d4d; font-weight: 800;"><i class="ri-lock-fill"></i> TIME EXPIRED</span>';
                    return;
                }

                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                timerEl.innerHTML = `<i class="ri-time-line"></i> EXPIRES IN: ${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        async function fetchEventInfo() {
            // Simple logic to get event title from list
            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch('/api/judge/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success) {
                    const event = data.data.find(e => e.id == currentEventId);
                    if (event) document.getElementById('eventNameHeader').innerText = event.title;
                }
            } catch (err) { }
        }

        async function fetchEntries() {
            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch(`/api/judge/events/${currentEventId}/entries`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    allEntries = data.data;
                    populateClassFilter();
                    renderEntries();
                }
            } catch (err) {
                console.error(err);
            }
        }

        function populateClassFilter() {
            const filter = document.getElementById('classFilter');
            const classes = [...new Set(allEntries.map(e => e.contest_class))].filter(Boolean).sort();

            // Keep "All" and add classes
            filter.innerHTML = '<option value="all">Semua Kelas</option>' +
                classes.map(c => `<option value="${escapeHTML(c)}">Kelas ${escapeHTML(c)}</option>`).join('');
        }

        function renderEntries() {
            const selectedClass = document.getElementById('classFilter').value;
            const entriesContainer = document.getElementById('entriesContainer');
            const compareGrid = document.getElementById('compareGrid');
            const isGridView = compareGrid.style.display === 'grid';

            // Grouping logic (depends on step/phase)
            let filtered = allEntries;
            let stepTitle = "";
            let stepHint = "";

            if (judgingPhase !== 'scoring') {
                if (currentChampionshipStep === 2) {
                    // Show only Juara 1
                    filtered = allEntries.filter(e => {
                        const res = eventEntriesForResults.find(r => r.id === e.id);
                        return res && res.winner_rank_class === 1;
                    });
                    stepTitle = "Pemilihan Best of Division (BOD)";
                } else if (currentChampionshipStep === 3) {
                    // Show only BOD winners
                    filtered = allEntries.filter(e => {
                        const res = eventEntriesForResults.find(r => r.id === e.id);
                        return res && res.winner_rank_bod === true;
                    });
                    stepTitle = "Pemilihan Grand Champion (GC)";
                } else if (selectedClass !== 'all') {
                    filtered = allEntries.filter(e => e.contest_class === selectedClass);
                }
            } else if (selectedClass !== 'all') {
                filtered = allEntries.filter(e => e.contest_class === selectedClass);
            }

            if (filtered.length === 0) {
                entriesContainer.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 5rem;">Belum ada kontestan yang memenuhi kriteria fase ini.</p>`;
                compareGrid.innerHTML = '';
                return;
            }

            // Group by Division & Class
            const divisions = {};
            filtered.forEach(entry => {
                const div = entry.contest_division || 'Tanpa Divisi';
                if (!divisions[div]) divisions[div] = {};

                const cls = entry.contest_class || 'Tanpa Kelas';
                if (!divisions[div][cls]) divisions[div][cls] = [];
                divisions[div][cls].push(entry);
            });

            // List View Rendering
            let listHtml = "";

            // Phase Control & Timer UI
            if (judgingPhase !== 'scoring' && judgingPhase !== 'finished') {
                listHtml += `
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(0,255,136,0.05); border-radius: 20px; border: 1px solid rgba(0,255,136,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h4 style="color: var(--secondary); margin: 0; font-size: 0.8rem; font-weight: 800; text-transform: uppercase;">Current Phase: ${judgingPhase.toUpperCase()}</h4>
                                <div id="phaseTimer" style="font-family: monospace; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;"></div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${judgingPhase === 'class' ? `<button onclick="setEventPhase('bod')" class="tab-btn" style="background: var(--secondary); color: #000; border: none; font-size: 0.7rem;">LOCK & START BOD</button>` : ''}
                                ${judgingPhase === 'bod' ? `<button onclick="setEventPhase('gc')" class="tab-btn" style="background: var(--secondary); color: #000; border: none; font-size: 0.7rem;">LOCK & START GC</button>` : ''}
                                ${judgingPhase === 'gc' ? `<button onclick="setEventPhase('finished')" class="tab-btn" style="background: var(--secondary); color: #000; border: none; font-size: 0.7rem;">FINISH COMPETITION</button>` : ''}
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">${stepHint || 'Mohon selesaikan penilaian di fase ini sebelum mengunci dan lanjut ke tahap berikutnya.'}</p>
                    </div>
                `;
            }

            for (const div in divisions) {
                listHtml += `
                    <div class="division-group" style="margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1.2rem; padding: 0 0.5rem;">
                            <span style="font-size: 0.9rem; font-weight: 800; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px;">DIVISI ${escapeHTML(div)}</span>
                            <div style="flex: 1; height: 1px; background: linear-gradient(to right, rgba(0,255,136,0.2), transparent);"></div>
                        </div>
                `;

                for (const cls in divisions[div]) {
                    const sortedClassEntries = [...divisions[div][cls]].sort((a, b) => (b.score || 0) - (a.score || 0));

                    listHtml += `
                        <div style="margin-left: 1rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                                <h5 style="color: var(--primary); font-size: 0.85rem; margin: 0; font-weight: 800; opacity: 0.8;">CLASS ${escapeHTML(cls)}</h5>
                                ${judgingPhase === 'class' && currentChampionshipStep === 1 ? `
                                    <button onclick="autoRankClass('${div}', '${cls}')" class="tab-btn" style="width: auto; height: auto; padding: 4px 10px; font-size: 0.7rem; background: rgba(0,212,255,0.1); border-color: rgba(0,212,255,0.2); font-weight: 800; color: var(--primary);">
                                        <i class="ri-magic-line"></i> AUTO RANK
                                    </button>
                                ` : ''}
                            </div>
                            <div style="display: grid; gap: 0.8rem;">
                                ${sortedClassEntries.map(entry => {
                        const resultsEntry = eventEntriesForResults.find(r => r.id === entry.id) || entry;
                        const isWinnerClass = resultsEntry.winner_rank_class;
                        const isBOD = resultsEntry.winner_rank_bod;
                        const isGC = resultsEntry.winner_rank_gc;

                        return `
                                        <div class="entry-card-mini animate-fade-in ${entry.id == document.getElementById('selectedEntryId').value ? 'active' : ''}" 
                                            onclick='selectEntry(${JSON.stringify(entry).replace(/'/g, "&#39;")})'
                                            style="${entry.score ? 'border-left: 4px solid var(--secondary);' : ''}">
                                            <div style="font-family: monospace; font-weight: 900; color: var(--primary); font-size: 0.8rem; padding: 4px 8px; background: rgba(0,212,255,0.1); border-radius: 8px; min-width: 80px; text-align: center;">${escapeHTML(entry.entry_number || '-')}</div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-weight: 800; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                                                    ${escapeHTML(entry.fish_name)}
                                                    ${isGC ? '<i class="ri-vip-crown-fill" style="color: #FFD700; font-size: 0.8rem;" title="Grand Champion"></i>' : ''}
                                                    ${isBOD ? '<i class="ri-medal-fill" style="color: #C0C0C0; font-size: 0.8rem;" title="Best of Division"></i>' : ''}
                                                    ${isWinnerClass ? `<span style="color: var(--secondary); font-size: 0.7rem; font-weight: 900;">#${isWinnerClass}</span>` : ''}
                                                </div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted);">${escapeHTML(entry.team_name || entry.contestant_name)} • ${escapeHTML(entry.fish_type)}</div>
                                            </div>
                                            ${entry.score ? `<div style="text-align: right;"><div style="font-size: 0.6rem; color: var(--text-muted); font-weight: 700;">SCORE</div><div style="color: var(--primary); font-weight: 900; font-size: 1.1rem;">${entry.score}</div></div>` : '<i class="ri-edit-2-line" style="color: var(--text-muted);"></i>'}
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                }
                listHtml += `</div>`;
            }
            entriesContainer.innerHTML = listHtml;

            // Step Navigation for Judges
            if (judgingPhase !== 'scoring' && judgingPhase !== 'finished') {
                let navHtml = `<div style="display: flex; gap: 10px; margin-top: 2rem; padding: 1rem; background: rgba(0,212,255,0.05); border-radius: 20px; border: 1px solid rgba(0,212,255,0.1);">`;

                const phases = [
                    { step: 1, key: 'class', label: '1: KELAS' },
                    { step: 2, key: 'bod', label: '2: BOD' },
                    { step: 3, key: 'gc', label: '3: GC' }
                ];

                phases.forEach(p => {
                    const isActive = currentChampionshipStep === p.step;
                    const isCurrentPhase = judgingPhase === p.key;
                    navHtml += `
                        <button onclick="setChampionshipStep(${p.step})" class="step-tab ${isActive ? 'active' : ''}" data-step="${p.step}" 
                            style="flex: 1; padding: 10px; border-radius: 12px; border: none; font-size: 0.75rem; font-weight: 800; cursor: pointer; transition: all 0.3s;
                            background: ${isActive ? 'var(--secondary)' : 'rgba(255,255,255,0.05)'}; 
                            color: ${isActive ? '#000' : 'rgba(255,255,255,0.4)'};
                            ${!isCurrentPhase ? 'opacity: 0.6;' : 'box-shadow: 0 0 10px rgba(0,255,136,0.2);'}">
                            ${isCurrentPhase ? '● ' : ''}${p.label}
                        </button>
                    `;
                });
                navHtml += `</div>`;
                entriesContainer.innerHTML = navHtml + listHtml;
            }

            // Grid View (Flat for comparison)
            compareGrid.innerHTML = filtered.map(entry => `
                <div class="compare-item animate-fade-in" onclick='selectEntry(${JSON.stringify(entry).replace(/'/g, "&#39;")})' style="cursor: pointer; position: relative; ${entry.id == document.getElementById('selectedEntryId').value ? 'border: 2px solid var(--primary);' : ''}">
                    <img src="${escapeHTML(entry.fish_image_url)}" style="width: 100%; height: 150px; object-fit: cover;">
                    <div style="padding: 1rem;">
                        <div style="font-weight: 800; font-size: 0.9rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${escapeHTML(entry.fish_name)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${escapeHTML(entry.fish_type)}</div>
                        ${entry.score ? `<div style="margin-top: 8px; font-weight: 900; color: var(--primary); font-size: 1.1rem;">${entry.score}</div>` : ''}
                    </div>
                    ${entry.winner_rank_class ? `<div style="position: absolute; top: 10px; right: 10px; background: rgba(0,255,136,0.9); color: #000; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800;"><i class="ri-trophy-fill"></i> Juara</div>` : ''}
                </div>
            `).join('');
        }

        function toggleCompareMode() {
            const list = document.getElementById('entriesContainer');
            const grid = document.getElementById('compareGrid');
            const btn = document.getElementById('compareToggle');

            if (list.style.display === 'none') {
                list.style.display = 'grid';
                grid.style.display = 'none';
                btn.innerHTML = '<i class="ri-layout-grid-line"></i> <span class="mobile-hide">Mode</span> Bandingkan';
                btn.classList.remove('active');
            } else {
                list.style.display = 'none';
                grid.style.display = 'grid';
                btn.innerHTML = '<i class="ri-list-check"></i> <span class="mobile-hide">Mode</span> List';
                btn.classList.add('active');
            }
        }

        function selectEntry(entry) {
            document.getElementById('noSelectMsg').style.display = 'none';
            document.getElementById('scoringSection').style.display = 'block';

            document.getElementById('selectedEntryId').value = entry.id;
            document.getElementById('fishTitle').innerText = entry.fish_name;
            document.getElementById('fishType').innerText = `${entry.fish_type} • Kelas ${entry.contest_class || '-'}`;
            document.getElementById('fishPreview').src = entry.fish_image_url;
            document.getElementById('teamVal').innerText = entry.team_name || '-';
            document.getElementById('waVal').innerText = entry.wa_number || '-';

            // Set Entry Number and Winner Badges
            let badgeHtml = `<span style="background: rgba(0,212,255,0.1); padding: 4px 10px; border-radius: 8px; font-family: monospace; font-weight: 900; color: var(--primary);">${escapeHTML(entry.entry_number || '-')}</span>`;

            if (entry.winner_rank_gc) badgeHtml += ' <span style="color: #FFD700; margin-left: 10px; font-weight: 800;"><i class="ri-vip-crown-fill"></i> GRAND CHAMPION</span>';
            else if (entry.winner_rank_bod) badgeHtml += ` <span style="color: #C0C0C0; margin-left: 10px; font-weight: 800;"><i class="ri-medal-fill"></i> BEST OF DIV ${entry.contest_division}</span>`;
            else if (entry.winner_rank_class) badgeHtml += ` <span style="color: var(--secondary); margin-left: 10px; font-weight: 800;"><i class="ri-trophy-fill"></i> JUARA ${entry.winner_rank_class} KELAS</span>`;

            document.getElementById('entryNumberVal').innerHTML = badgeHtml;

            // Video Reset
            const fishPreview = document.getElementById('fishPreview');
            const fishVideo = document.getElementById('fishVideo');
            const toggleContainer = document.getElementById('mediaToggleContainer');
            const toggleBtn = document.getElementById('mediaToggleBtn');

            // Always start with photo
            fishPreview.style.display = 'block';
            fishVideo.style.display = 'none';
            fishVideo.pause();
            fishVideo.src = '';
            toggleBtn.innerHTML = '<i class="ri-play-circle-fill" style="font-size: 1.2rem;"></i> LIAT VIDEO';

            if (entry.video_url) {
                toggleContainer.style.display = 'block';
                fishVideo.src = entry.video_url;
            } else {
                toggleContainer.style.display = 'none';
            }

            // Set scores from entry (if any)
            document.getElementById('input_body').value = entry.score_body || 0;
            document.getElementById('input_form').value = entry.score_form || 0;
            document.getElementById('input_color').value = entry.score_color || 0;
            document.getElementById('judgeComment').value = entry.judge_comment || '';

            updateScoreUI();

            // Render Winner Controls for Judges
            renderWinnerControls(entry);

            renderEntries();

            if (window.innerWidth < 1024) {
                document.getElementById('scoringSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function renderWinnerControls(entry) {
            const containerId = 'winnerControlsContainer';
            let container = document.getElementById(containerId);

            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                container.style.marginTop = '1.5rem';
                container.style.padding = '1.2rem';
                container.style.background = 'rgba(0,255,136,0.05)';
                container.style.borderRadius = '18px';
                container.style.border = '1px solid rgba(0,255,136,0.1)';
                document.getElementById('scoringForm').insertAdjacentElement('beforebegin', container);
            }

            if (judgingPhase === 'scoring' || judgingPhase === 'finished') {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            const isWinnerClass = entry.winner_rank_class;
            const isBOD = entry.winner_rank_bod;
            const isGC = entry.winner_rank_gc;

            let html = `<h4 style="font-size: 0.8rem; font-weight: 800; color: var(--secondary); margin-bottom: 1rem; text-transform: uppercase;">Penentuan Pemenang (${judgingPhase.toUpperCase()})</h4>`;

            if (currentChampionshipStep === 1) {
                html += `
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select onchange="assignWinnerRank(${entry.id}, 'class', this.value)" style="flex: 1; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; padding: 10px; border-radius: 10px; font-weight: 700;">
                            <option value="">- Pilih Rank Kelas -</option>
                            <option value="1" ${entry.winner_rank_class === 1 ? 'selected' : ''}>Juara 1</option>
                            <option value="2" ${entry.winner_rank_class === 2 ? 'selected' : ''}>Juara 2</option>
                            <option value="3" ${entry.winner_rank_class === 3 ? 'selected' : ''}>Juara 3</option>
                        </select>
                    </div>
                `;
            } else if (currentChampionshipStep === 2) {
                html += `
                    <button onclick="assignWinnerRank(${entry.id}, 'bod', ${!isBOD})" class="action-btn" style="width: 100%; padding: 12px; border-radius: 12px; font-weight: 800; background: ${isBOD ? '#C0C0C0' : 'rgba(192,192,192,0.1)'}; color: ${isBOD ? '#000' : '#fff'}; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="ri-medal-fill"></i> ${isBOD ? 'BOD AKTIF' : 'SET SEBAGAI BEST OF DIVISION'}
                    </button>
                `;
            } else if (currentChampionshipStep === 3) {
                html += `
                    <button onclick="assignWinnerRank(${entry.id}, 'gc', ${!isGC})" class="action-btn" style="width: 100%; padding: 12px; border-radius: 12px; font-weight: 800; background: ${isGC ? '#FFD700' : 'rgba(255,215,0,0.1)'}; color: ${isGC ? '#000' : '#fff'}; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="ri-vip-crown-fill"></i> ${isGC ? 'GC AKTIF' : 'SET SEBAGAI GRAND CHAMPION'}
                    </button>
                `;
            }

            container.innerHTML = html;
        }

        async function assignWinnerRank(id, tier, rank) {
            const token = localStorage.getItem('sna_user_token');
            try {
                // Check if phase is expired locally
                if (phaseExpiry && new Date() > phaseExpiry) {
                    alert('Fase sudah berakhir/dikunci. Hubungi Admin jika diperlukan.');
                    return;
                }

                const res = await fetch('/api/admin/judging/winners/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ id, tier, rank, eventId: currentEventId })
                });
                if (res.ok) {
                    const data = await res.json();
                    fetchJudgingData(); // Refresh all results for consistency
                } else {
                    const err = await res.json();
                    alert('Gagal: ' + (err.error || 'Terjadi kesalahan'));
                }
            } catch (err) { alert('Gagal: ' + err.message); }
        }

        async function autoRankClass(div, cls) {
            const classEntries = allEntries.filter(e => e.contest_division === div && e.contest_class === cls);
            const sorted = [...classEntries].sort((a, b) => (b.score || 0) - (a.score || 0));

            if (confirm(`Otomatis set Juara 1-2-3 untuk Class ${cls} berdasarkan skor tertinggi?`)) {
                for (let i = 0; i < Math.min(3, sorted.length); i++) {
                    await assignWinnerRank(sorted[i].id, 'class', i + 1);
                }
                alert(`Auto Rank Selesai untuk Class ${cls}`);
            }
        }

        function updateScoreUI() {
            const body = parseInt(document.getElementById('input_body').value);
            const form = parseInt(document.getElementById('input_form').value);
            const color = parseInt(document.getElementById('input_color').value);

            document.getElementById('bodyVal').innerText = body;
            document.getElementById('formVal').innerText = form;
            document.getElementById('colorVal').innerText = color;

            const total = Math.round((body + form + color) / 3);
            document.getElementById('totalScoreVal').innerText = total;
        }

        function toggleMedia() {
            const preview = document.getElementById('fishPreview');
            const video = document.getElementById('fishVideo');
            const btn = document.getElementById('mediaToggleBtn');

            if (video.style.display === 'none') {
                preview.style.display = 'none';
                video.style.display = 'block';
                video.play();
                btn.innerHTML = '<i class="ri-image-fill" style="font-size: 1.2rem;"></i> LIAT FOTO';
            } else {
                preview.style.display = 'block';
                video.style.display = 'none';
                video.pause();
                btn.innerHTML = '<i class="ri-play-circle-fill" style="font-size: 1.2rem;"></i> LIAT VIDEO';
            }
        }

        function cancelScoring() {
            document.getElementById('selectedEntryId').value = '';
            document.getElementById('scoringSection').style.display = 'none';
            document.getElementById('noSelectMsg').style.display = 'block';
            renderEntries();
        }

        document.getElementById('scoringForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('selectedEntryId').value;
            const payload = {
                score_body: parseInt(document.getElementById('input_body').value),
                score_form: parseInt(document.getElementById('input_form').value),
                score_color: parseInt(document.getElementById('input_color').value),
                comment: document.getElementById('judgeComment').value
            };

            const token = localStorage.getItem('sna_user_token');
            try {
                const res = await fetch(`/api/judge/entries/${id}/score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    alert('Penilaian berhasil disimpan!');
                    fetchEntries();
                    cancelScoring();
                } else {
                    const error = await res.json();
                    let msg = 'Gagal: ' + (error.error || 'Terjadi kesalahan');
                    if (error.details) msg += '\n\nDetail: ' + error.details;
                    if (error.hint) msg += '\n\nSaran: ' + error.hint;
                    alert(msg);
                }
            } catch (err) {
                console.error(err);
                alert('Gagal menyimpan nilai. Periksa koneksi internet Anda atau hubungi admin.');
            }
        });
        // Navbar scroll effect
        window.addEventListener('scroll', () => {
            const nav = document.querySelector('.navbar');
            if (window.scrollY > 20) {
                nav.classList.add('scrolled');
            } else {
                nav.classList.remove('scrolled');
            }
        });

        function toggleMenu() {
            const navOverlay = document.getElementById('navOverlay');
            const navBackdrop = document.getElementById('navBackdrop');
            navOverlay.classList.toggle('active');
            navBackdrop.classList.toggle('active');
        }

        // Hamburger button event listener (fix for multiple elements)
        document.querySelectorAll('.hamburger-btn').forEach(btn => {
            btn.onclick = toggleMenu;
        });

    </script>
    <script src="js/navigation.js"></script>
</body>

</html>