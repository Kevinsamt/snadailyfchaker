<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnaDaily - Pendaftaran Ikan Kontes</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/seasonal-themes.css">
    <script src="js/seasonal-manager.js" defer></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .entry-card {
            width: 100%;
            max-width: 600px;
            padding: 3rem;
        }

        .image-preview-container {
            width: 100%;
            height: 250px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .image-preview-container:hover {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .preview-placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .preview-placeholder i {
            font-size: 3rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Spin Wheel Styles */
        .spin-wheel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            border: 8px solid var(--primary);
            border-radius: 50%;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
            box-shadow: 0 0 50px var(--primary-glow);
        }

        .wheel-segment {
            position: absolute;
            width: 100%;
            height: 100%;
            clip-path: polygon(50% 50%, 50% 0, 100% 0, 100% 20%);
            transform-origin: 50% 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 40px;
            font-size: 0.7rem;
            font-weight: 800;
            color: #000;
            text-transform: uppercase;
        }

        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid var(--accent);
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }

        .tier-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .tier-card:hover {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.06);
        }

        .tier-card.active {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .tier-price {
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--primary);
            display: block;
        }

        .tier-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>

<body>
    <div class="ocean-background">
        <div class="bubble x1"></div>
        <div class="bubble x2"></div>
        <div class="bubble x3"></div>
    </div>

    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="text-gradient"
                style="font-size: 1.5rem; font-weight: 800; text-decoration: none; letter-spacing: -1px;">SnaDaily<span
                    style="color: white; font-weight: 300;">Checker</span></a>

            <button class="hamburger-btn" onclick="toggleMenu()">
                <i class="ri-menu-4-line"></i>
            </button>
        </div>
    </nav>

    <!-- Nav Overlay -->
    <div class="nav-overlay-backdrop" id="navBackdrop" onclick="toggleMenu()"></div>
    <div class="nav-overlay" id="navOverlay" style="text-align: left;">
        <div class="nav-menu-header">
            <span class="text-gradient" style="font-weight: 800; font-size: 1.25rem;">MENU</span>
            <button class="hamburger-btn" onclick="toggleMenu()" style="font-size: 1.25rem;">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="nav-menu-links">
            <a href="index.html" class="nav-menu-link">
                <i class="ri-home-4-line"></i> Beranda
            </a>
            <a href="events.html" class="nav-menu-link">
                <i class="ri-calendar-event-line"></i> Event Kontes
            </a>
            <a href="track.html" class="nav-menu-link">
                <i class="ri-truck-line"></i> Lacak Pesanan
            </a>
            <div id="userMenuLinks"></div>
        </div>
    </div>

    <main class="container flex-center" style="min-height: calc(100vh - 80px);">
        <div class="glass-panel entry-card animate-fade-in" id="entryPanel">
            <!-- Left Side: Decorative/Preview -->
            <div class="m-hide"
                style="background: linear-gradient(135deg, var(--bg-deep), var(--bg-dark)); padding: 3rem; display: flex; flex-direction: column; justify-content: center; border-right: 1px solid var(--glass-border);">
                <div style="margin-bottom: 2rem;">
                    <div
                        style="width: 50px; height: 4px; background: var(--primary); margin-bottom: 1.5rem; border-radius: 10px;">
                    </div>
                    <h1 style="font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 1rem;">Registrasi
                        <span class="text-gradient">Ikan</span>
                    </h1>
                    <p style="color: var(--text-dim); font-size: 0.95rem;">Daftarkan ikan cupang terbaikmu untuk
                        mengikuti kontes bergengsi.</p>
                </div>

                <div class="image-preview-container" id="dropZone" style="height: 200px; margin-bottom: 0;">
                    <div class="preview-placeholder" id="placeholder">
                        <i class="ri-image-add-line" style="font-size: 2.5rem; color: var(--primary);"></i>
                        <span style="display: block; font-size: 0.85rem; margin-top: 0.5rem;">Preview Foto Ikan</span>
                    </div>
                    <img id="previewImage" class="preview-img">
                </div>
            </div>

            <!-- Right Side: Form -->
            <div style="padding: 3rem;">
                <form id="entryForm">
                    <div class="input-group">
                        <label class="input-label">Pilih Event Kontes</label>
                        <select id="eventName" class="glass-input" required style="cursor: pointer;">
                            <option value="">Memuat event...</option>
                        </select>
                    </div>

                    <div class="grid-2 mb-3">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Nama Ikan</label>
                            <input type="text" id="fishName" class="glass-input" placeholder="e.g., Red Dragon"
                                required>
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Kelas Kontes</label>
                            <select id="contestClass" class="glass-input" required>
                                <optgroup label="Kelas A - Plakat Series">
                                    <option value="A1">A1 - Plakat Basic Color (Besgel/Or/Bester)</option>
                                    <option value="A2">A2 - Multicolor</option>
                                    <option value="A3">A3 - Pelakat Rim Series</option>
                                </optgroup>
                                <optgroup label="Kelas B - Halfmoon Series">
                                    <option value="B1">B1 - HM Basic Color (Besgel/Or/Bester)</option>
                                    <option value="B2">B2 - HM Multi</option>
                                </optgroup>
                                <optgroup label="Kelas C - Special Class">
                                    <option value="C1">C1 - FM Open</option>
                                    <option value="C2">C2 - Longfin VT</option>
                                    <option value="C3">C3 - PKDE (Plakat King Dumbo Edition)</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label class="input-label">Pilih Tier Registrasi</label>
                        <div class="grid-2" style="gap: 10px;">
                            <div class="tier-card active" onclick="selectTier('Early', 40000, this)">
                                <span class="tier-label">Early</span>
                                <span class="tier-price">40K</span>
                            </div>
                            <div class="tier-card" onclick="selectTier('Mid', 60000, this)">
                                <span class="tier-label">Mid</span>
                                <span class="tier-price">60K</span>
                            </div>
                            <div class="tier-card" onclick="selectTier('Last', 80000, this)">
                                <span class="tier-label">Last</span>
                                <span class="tier-price">80K</span>
                            </div>
                            <div class="tier-card" onclick="selectTier('Diamond', 100000, this)"
                                style="border-color: #FFD700; background: rgba(255, 215, 0, 0.05);">
                                <span class="tier-label" style="color: #FFD700;">Diamond</span>
                                <span class="tier-price" style="color: #FFD700;">100K</span>
                                <span style="font-size: 0.6rem; color: #FFD700; display: block; margin-top: 4px;">+ SPIN
                                    WHEAL</span>
                            </div>
                        </div>
                        <input type="hidden" id="registrationTier" value="Early">
                        <input type="hidden" id="paymentAmount" value="40000">
                    </div>

                    <div class="grid-2 mb-3">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Nama Tim / Handle</label>
                            <input type="text" id="teamName" class="glass-input" placeholder="Nama Tim (Opsional)">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Nomor WhatsApp (Aktif)</label>
                            <input type="tel" id="waNumber" class="glass-input" placeholder="08xxxx" required>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Alamat Lengkap (Untuk Pengiriman Piala)</label>
                        <textarea id="fullAddress" class="glass-input" style="height: 80px; resize: none;"
                            placeholder="Jl. Merdeka No. 123..." required></textarea>
                    </div>

                    <div class="grid-2 mb-3">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Upload Foto Ikan (JPG/PNG)</label>
                            <input type="file" id="fishPhotoFile" class="glass-input" accept="image/*" required
                                onchange="handleFileSelect(this, 'photo')">
                            <div id="photoProgressContainer" class="progress-wrap" style="display: none;">
                                <div id="photoProgressBar" class="progress-bar"></div>
                            </div>
                            <input type="hidden" id="imgUrl">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Upload Video Ikan (Durasi 2-7 Menit)</label>
                            <input type="file" id="fishVideoFile" class="glass-input" accept="video/*" required
                                onchange="handleFileSelect(this, 'video')">
                            <div id="videoProgressContainer" class="progress-wrap" style="display: none;">
                                <div id="videoProgressBar" class="progress-bar"></div>
                            </div>
                            <input type="hidden" id="videoUrl">
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;" id="submitBtn">
                        <i class="ri-send-plane-fill"></i> SUBMIT PENDAFTARAN
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- Diamond Spin Wheel Overlay -->
    <div id="spinOverlay" class="spin-wheel-overlay">
        <h2 style="color: #FFD700; font-size: 2rem; margin-bottom: 2rem; font-weight: 800;">DIAMOND LUCK!</h2>
        <div style="position: relative;">
            <div class="wheel-pointer"></div>
            <div id="wheel" class="wheel-container">
                <!-- Segments will be injected by JS -->
            </div>
        </div>
        <button id="spinBtn" class="btn-primary"
            style="margin-top: 3rem; background: #FFD700; border-radius: 12px; padding: 1rem 3rem;">
            PUTAR SEKARANG!
        </button>
        <div id="prizeResult" style="margin-top: 2rem; display: none; text-align: center;">
            <h3 style="color: white; font-size: 1.5rem; margin-bottom: 1rem;">Selamat! Anda mendapatkan:</h3>
            <div id="prizeLabel"
                style="font-size: 2.5rem; font-weight: 900; color: #FFD700; text-transform: uppercase; text-shadow: 0 0 20px rgba(255,215,0,0.5);">
                PRIZE</div>
            <button onclick="finishRegistration()" class="btn-primary" style="margin-top: 2rem;">SELESAI</button>
        </div>
    </div>

    <style>
        .entry-card {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            overflow: hidden;
            padding: 0;
        }

        @media (max-width: 768px) {
            .entry-card {
                grid-template-columns: 1fr !important;
                margin: 1rem 0;
            }

            .entry-card>div:last-child {
                padding: 2rem 1.5rem !important;
            }

            /* Mini branding for mobile */
            #entryPanel::before {
                content: 'Registrasi Kontes';
                display: block;
                padding: 1.5rem 1.5rem 0.5rem;
                font-size: 1.25rem;
                font-weight: 800;
                color: var(--primary);
                text-align: center;
            }
        }
    </style>
    <script src="js/navigation.js"></script>
    <script>
        // Check Auth
        if (!localStorage.getItem('sna_user_token')) {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const userData = JSON.parse(localStorage.getItem('sna_user_data'));
            const userMenuLinks = document.getElementById('userMenuLinks');

            if (userData) {
                userMenuLinks.innerHTML = `
    <a href="dashboard.html" class="nav-menu-link">
        <i class="ri-dashboard-line"></i> Dashboard
    </a>
    <a href="#" onclick="logout()" class="nav-menu-link" style="color: var(--error);">
        <i class="ri-logout-box-r-line"></i> Logout
    </a>
    `;
            } else {
                userMenuLinks.innerHTML = `
    <a href="login.html" class="nav-menu-link">
        <i class="ri-user-line"></i> Login
    </a>
    <a href="register.html" class="nav-menu-link" style="color: var(--secondary);">
        <i class="ri-user-add-line"></i> Daftar Akun
    </a>
    `;
            }

            // Moved event fetching logic into DOMContentLoaded
            const urlParams = new URLSearchParams(window.location.search);
            const selectedEvent = urlParams.get('event');

            try {
                const res = await fetch('/api/events');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('eventName');
                    select.innerHTML = '<option value="">Pilih Event...</option>' +
                        data.data.filter(ev => ev.status !== 'past').map(ev =>
                            `<option value="${ev.title}" ${selectedEvent === decodeURIComponent(ev.title) ? 'selected' : ''}>${ev.title}</option>
    `
                        ).join('');
                }
            } catch (err) {
                console.error('Error fetching events:', err);
                document.getElementById('eventName').innerHTML = '<option value="">Gagal memuat event</option>';
            }
        });

        function updatePreview(url) {
            const preview = document.getElementById('previewImage');
            const placeholder = document.getElementById('placeholder');
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        async function handleFileSelect(input, type) {
            const file = input.files[0];
            if (!file) return;

            // Optional: Preview for photo
            if (type === 'photo') {
                const reader = new FileReader();
                reader.onload = (e) => updatePreview(e.target.result);
                reader.readAsDataURL(file);
            }
        }

        function selectTier(tier, price, element) {
            document.querySelectorAll('.tier-card').forEach(c => c.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('registrationTier').value = tier;
            document.getElementById('paymentAmount').value = price;
        }

        const PRIZES = ["Slot Registrasi", "Ikan Random", "Pink Aurora", "Slot Registrasi", "Ikan Random", "Zonk"];
        let currentSpinPrize = "";

        function initWheel() {
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';
            const colors = ['#FFD700', '#FF4500', '#FFD700', '#FF4500', '#FFD700', '#C0C0C0'];

            PRIZES.forEach((prize, i) => {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                segment.style.transform = `rotate(${i * 60}deg)`;
                segment.style.backgroundColor = colors[i];
                segment.innerText = prize;
                wheel.appendChild(segment);
            });
        }

        function spinWheel() {
            const wheel = document.getElementById('wheel');
            const spinBtn = document.getElementById('spinBtn');
            const randomDegree = 1800 + Math.floor(Math.random() * 360);

            spinBtn.style.display = 'none';
            wheel.style.transform = `rotate(${randomDegree}deg)`;

            setTimeout(() => {
                const actualDegree = randomDegree % 360;
                // Wheel segments are 60 degrees each. Pointer is at 0 deg (top).
                // Logic to determine prize based on final rotation.
                // Simplified for demo:
                const prizeIndex = Math.floor(((360 - (actualDegree % 360)) % 360) / 60);
                currentSpinPrize = PRIZES[prizeIndex];

                document.getElementById('prizeLabel').innerText = currentSpinPrize;
                document.getElementById('prizeResult').style.display = 'block';
            }, 4100);
        }

        document.getElementById('spinBtn').onclick = spinWheel;

        async function finishRegistration() {
            window.location.href = 'dashboard.html';
        }

        document.getElementById('entryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const token = localStorage.getItem('sna_user_token');
            const tier = document.getElementById('registrationTier').value;

            const formData = new FormData();
            formData.append('contestName', document.getElementById('eventName').value);
            formData.append('fishName', document.getElementById('fishName').value);
            formData.append('fishType', 'N/A'); // Backward compatibility
            formData.append('contestClass', document.getElementById('contestClass').value);
            formData.append('registrationTier', tier);
            formData.append('paymentAmount', document.getElementById('paymentAmount').value);
            formData.append('teamName', document.getElementById('teamName').value);
            formData.append('waNumber', document.getElementById('waNumber').value);
            formData.append('fullAddress', document.getElementById('fullAddress').value);

            if (currentSpinPrize) {
                formData.append('spinPrize', currentSpinPrize);
            }

            // Append files
            const photoFile = document.getElementById('fishPhotoFile').files[0];
            const videoFile = document.getElementById('fishVideoFile').files[0];

            if (photoFile) formData.append('fishPhoto', photoFile);
            if (videoFile) formData.append('fishVideo', videoFile);

            btn.disabled = true;
            btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Sedang Mengunggah...';

            try {
                const response = await fetch('/api/contest/register', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    if (tier === 'Diamond') {
                        document.getElementById('spinOverlay').style.display = 'flex';
                        initWheel();
                    } else {
                        btn.style.background = 'var(--success)';
                        btn.innerHTML = '<i class="ri-check-line"></i> Terkirim & Terupload!';
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                    }
                } else {
                    if (response.status === 413) {
                        throw new Error("Ukuran file (foto/video) terlalu besar! Maksimal total 4.5 MB. Coba upload video yang lebih pendek.");
                    }
                    const data = await response.json();
                    throw new Error(data.error || 'Gagal mendaftar');
                }
            } catch (err) {
                alert(err.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="ri-send-plane-fill"></i> SUBMIT PENDAFTARAN';
            }
        });

        // Autofill logic removed as it's handled in fetchEvents dropdown rendering
    </script>
</body>

</html>