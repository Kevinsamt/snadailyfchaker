<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnaDaily - Pendaftaran Ikan Kontes</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .entry-card {
            width: 100%;
            max-width: 600px;
            padding: 3rem;
        }

        .image-preview-container {
            width: 100%;
            height: 250px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .image-preview-container:hover {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .preview-placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .preview-placeholder i {
            font-size: 3rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="ocean-background">
        <div class="bubble x1"></div>
        <div class="bubble x2"></div>
        <div class="bubble x3"></div>
    </div>

    <nav class="navbar">
        <div class="container nav-container">
            <a href="events.html" class="text-gradient"
                style="font-size: 1.5rem; font-weight: 800; text-decoration: none; letter-spacing: -1px;">SnaDaily<span
                    style="color: white; font-weight: 400;">Cheker</span></a>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <a href="events.html"
                    style="color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 0.9rem;">Batal</a>
            </div>
        </div>
    </nav>

    <main class="container flex-center" style="min-height: calc(100vh - 80px);">
        <div class="glass-panel entry-card animate-fade-in" id="entryPanel">
            <!-- Left Side: Decorative/Preview -->
            <div class="m-hide"
                style="background: linear-gradient(135deg, var(--bg-deep), var(--bg-dark)); padding: 3rem; display: flex; flex-direction: column; justify-content: center; border-right: 1px solid var(--glass-border);">
                <div style="margin-bottom: 2rem;">
                    <div
                        style="width: 50px; height: 4px; background: var(--primary); margin-bottom: 1.5rem; border-radius: 10px;">
                    </div>
                    <h1 style="font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 1rem;">Registrasi
                        <span class="text-gradient">Ikan</span>
                    </h1>
                    <p style="color: var(--text-dim); font-size: 0.95rem;">Daftarkan ikan cupang terbaikmu untuk
                        mengikuti kontes bergengsi.</p>
                </div>

                <div class="image-preview-container" id="dropZone" style="height: 200px; margin-bottom: 0;">
                    <div class="preview-placeholder" id="placeholder">
                        <i class="ri-image-add-line" style="font-size: 2.5rem; color: var(--primary);"></i>
                        <span style="display: block; font-size: 0.85rem; margin-top: 0.5rem;">Preview Foto Ikan</span>
                    </div>
                    <img id="previewImage" class="preview-img">
                </div>
            </div>

            <!-- Right Side: Form -->
            <div style="padding: 3rem;">
                <form id="entryForm">
                    <div class="input-group">
                        <label class="input-label">Pilih Event Kontes</label>
                        <select id="eventName" class="glass-input" required style="cursor: pointer;">
                            <option value="">Memuat event...</option>
                        </select>
                    </div>

                    <div class="grid-2 mb-3">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Nama Ikan</label>
                            <input type="text" id="fishName" class="glass-input" placeholder="e.g., Red Dragon"
                                required>
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">Tipe / Kategori</label>
                            <select id="fishType" class="glass-input" required>
                                <option value="Halfmoon">Halfmoon</option>
                                <option value="Plakat">Plakat</option>
                                <option value="Crowntail">Crowntail</option>
                                <option value="Double Tail">Double Tail</option>
                                <option value="Giant">Giant</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">URL Foto Ikan</label>
                        <input type="url" id="imgUrl" class="glass-input" placeholder="https://..." required
                            onchange="updatePreview(this.value)">
                    </div>

                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;" id="submitBtn">
                        <i class="ri-send-plane-fill"></i> SUBMIT PENDAFTARAN
                    </button>
                </form>
            </div>
        </div>
    </main>

    <style>
        .entry-card {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            overflow: hidden;
            padding: 0;
        }

        @media (max-width: 768px) {
            .entry-card {
                grid-template-columns: 1fr !important;
                margin: 1rem 0;
            }

            .entry-card>div:last-child {
                padding: 2rem 1.5rem !important;
            }

            /* Mini branding for mobile */
            #entryPanel::before {
                content: 'Registrasi Kontes';
                display: block;
                padding: 1.5rem 1.5rem 0.5rem;
                font-size: 1.25rem;
                font-weight: 800;
                color: var(--primary);
                text-align: center;
            }
        }
    </style>
    </style>

    <script>
        // Check Auth
        if (!localStorage.getItem('sna_user_token')) {
            window.location.href = 'login.html';
        }

        async function fetchEvents() {
            const urlParams = new URLSearchParams(window.location.search);
            const selectedEvent = urlParams.get('event');

            try {
                const res = await fetch('/api/events');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('eventName');
                    select.innerHTML = '<option value="">Pilih Event...</option>' +
                        data.data.filter(ev => ev.status !== 'past').map(ev =>
                            `<option value="${ev.title}" ${selectedEvent === decodeURIComponent(ev.title) ? 'selected' : ''}>${ev.title}</option>`
                        ).join('');
                }
            } catch (err) {
                console.error('Error fetching events:', err);
                document.getElementById('eventName').innerHTML = '<option value="">Gagal memuat event</option>';
            }
        }

        fetchEvents();

        function updatePreview(url) {
            const preview = document.getElementById('previewImage');
            const placeholder = document.getElementById('placeholder');
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        document.getElementById('entryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const token = localStorage.getItem('sna_user_token');

            const payload = {
                contestName: document.getElementById('eventName').value,
                fishName: document.getElementById('fishName').value,
                fishType: document.getElementById('fishType').value,
                fishImageUrl: document.getElementById('imgUrl').value
            };

            btn.disabled = true;
            btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Mengirim...';

            try {
                const response = await fetch('/api/contest/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    btn.style.background = 'var(--success)';
                    btn.innerHTML = '<i class="ri-check-line"></i> Terkirim!';
                    setTimeout(() => {
                        window.location.href = 'events.html';
                    }, 1500);
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Gagal mendaftar');
                }
            } catch (err) {
                alert(err.message);
                btn.disabled = false;
                btn.innerHTML = 'SUBMIT PENDAFTARAN';
            }
        });

        // Autofill logic removed as it's handled in fetchEvents dropdown rendering
    </script>
</body>

</html>